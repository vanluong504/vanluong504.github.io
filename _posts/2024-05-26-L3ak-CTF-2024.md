---
title: L3ak CTF 2024 - Writeup
date: 2024-05-26 00:00:00
categories: [CTF]
tags: [CTF, L3ak CTF 2024]
image: /assets/image/CTF/L3akCTF2024/logo.png
math: true
---

### Matrix Magic

#### Attachments

```python

from sage.all import *
from Crypto.Util.number import getPrime, isPrime
import os

def get_random(n):
    return int.from_bytes(os.urandom(n//8  + 1), "big")

def get_safe_prime(nbit):
    result = 2 * getPrime(nbit // 2) * getPrime(nbit // 2) + 1
    while not isPrime(int(result)):
        result = 2 * getPrime(nbit // 2) * getPrime(nbit // 2) + 1
    return result


FLAG = int.from_bytes(open("flag.txt", "rb").read().strip(), "big")

nbit = 1024

p = get_safe_prime(nbit // 2)
q = get_safe_prime(nbit // 2)
n = p*q

Mat = matrix(Zmod(n), [
    [2, 1] + [get_random(nbit) for _ in range(4)],
    [0, 2] + [get_random(nbit) for _ in range(4)],
    [0, 0] + [4, 1] + [get_random(nbit) for _ in range(2)],
    [0, 0] + [0, 4] + [get_random(nbit) for _ in range(2)],
    [0, 0] + [0, 0] + [8, 1],
    [0, 0] + [0, 0] + [0, 8]
])

C = Mat^FLAG
C = list(C)

with open("output.txt", "w") as f:
    f.write(f"{C = }")
```

```text
# output
C = [(34285747519707996626385667339662460790207453899564234933279840884637317470277963204844978855648863282661822817842406467276103235437115285776600339324582650206354227684286926765912841373720037206104315460984467834472878792871363724319500026730744559032592830317957861116684230815080884748210510265257121727411, 82389813574193236731268728055226346949935905889688170425892513962291738546070054175286986817742962125712704451033935523159914920684418980229184675189392660990212113237529057511102468180315624316711603102279872782413287481544411903032504611191117588506754985276936284421146109462510942343677179125102460355334, 127247078267314356402767966557448505733207679608121587776826570427528349536126399258128998506925096202352385266899982179247602157054605592001529350471426605916092686761690699179270970709575073044160148478140835495982904453410049961250136921488023338211130908836050232268149658252094451825981649386429967157023, 110997696050305177374684801376195205614043414698289134283464488914579055650336577562089998807469786126102628845652757901772021003891120075086100794690060492018372114798499796476503564426511552576093110306562634265833200794380828146503816203682087385703698944330589010185628240036153869595329794474678963954269, 95429943964904023259514531987953637596024020044100694025548029082876352647190904910373013883591092911247251504859346180249828148105405110896981416324094823746473360350150849817138654025822760100976625537661710179191573475427725481576122332324895773326199055069720422096583714906980119788052757109463536989130, 76925650644921944564121660415039326382672571942134701742579804900375156897677412516140878223663671839157682242947665571676520752706843330108967323669457404588586535061237444710279897627741144122937187393054928934936687732687921193790751566393662886825169077208127284176632544803227991370949818150005932210304), (0, 34285747519707996626385667339662460790207453899564234933279840884637317470277963204844978855648863282661822817842406467276103235437115285776600339324582650206354227684286926765912841373720037206104315460984467834472878792871363724319500026730744559032592830317957861116684230815080884748210510265257121727411, 85967636444726554256032386847538080607273641997139556709873191645024773479482183751659433639594934875197169824518560503372716992088412826701271790577397701838066670897181757432783438839115526851698428389903365201752735197054876789440370911041505435306549154757322168278884403206082946661059841799276902279607, 110321848943899292929831522195898953167052692821484311182642200713072229078674653831094653900345561159369211814825383018259327689455180388330932020089176571654576145870074563603252413779245365342554600824303390696086590372070050354595330074227342114164575397697848706436203854215556384244963529017935602600689, 55321436108075224950728586469455754360500596962017688262306497027259209074949803121055336152763619653715618911652213266949708309957674991371935559144633368828172207173145372615220450607178667764319048810554905786212377479905241378131059006116348325599909367174854478256625377537634718283487921887388679931300, 121048214328487578063535470984430739166205977393814304445813791572773220134359940700786671669567539273399625221907347167959074671295760177948556479010579225978917918535032412717072730223986401267581116138177971941402742413385270319230751393845616816965070450211819298226894334399356881715479006792296977303116), (0, 0, 80891788386112939497749276978496951092908047537517752191112348346041605282820278415204830919700840360371114407873821260986140627885494462923855784343766007471406691139724032186081486065167152331309928933439563087594932165713814698240940689654799590764311096627705559355661741126880749623083953480524440103996, 98127807327139994371479310755482264253499077621954160265776803909962087269443207623777017430975688540885576031084499718360878131623357206459366594111595569751254398053416214104147757969318816248746123610412479211529236153906708864168414330919431944363564172025204269508207805032491500543298879609362168155698, 65511482182385099252523608525317643713139065614405324455763784441479732896196144143630212812577305057210145612770975280343168022555945650814573970996890826522557999047275529322348420693034478105886809355222570889445527587635177667364042090723912339748512431185136779345494523747668733698804934976215893958288, 47395420931311533463576620820998773093140094423967370338777509171164699213419123512474441784558146041667540557107610725716163070022770572094504815720978368593469076026134774205916872923158523446883115622548066715665889163816586554653727221255672945695748970848307935789400330008330191289067490505817853508862), (0, 0, 0, 80891788386112939497749276978496951092908047537517752191112348346041605282820278415204830919700840360371114407873821260986140627885494462923855784343766007471406691139724032186081486065167152331309928933439563087594932165713814698240940689654799590764311096627705559355661741126880749623083953480524440103996, 19698820472058378412126192842030797220400882933373012220982539297272840493833295012123104281630408975161684583174403520414441877705582176563034772573895923595952612217426667572338807473485060098014543992573292667351072747962727283791740574278403611513201362656878372277715791010274896917611983518661952140153, 123510953871821884312855093053364645536177520009689630246292371010124299893864894909800725518340823661094473516585146142340021906280407678497822070318952778328284650261834023459467329786786889648844029738405121401290299843929018994002831246816483309594538299064894303565350991068375984784398159294612728278815), (0, 0, 0, 0, 36580210170460317737762146444885635769591964296289890711389087000847139534806165797517572963756420701630101713343229692997790887039708011239887899158602488099058023454307392387825436996066794401349180417178870019892425641929320878895403740655587101563655595067050855919740156100994268635382369423383067032821, 39071393947194921035771816301731926515001496696996162605545586710593160202215733075781810261530483080161843001707288615255381706789857593381598670763208249387924275996361728526530257131514765795139507343167639937751870811497537961210868263876827751668386006289349446841212411861730197725192485058916383785937), (0, 0, 0, 0, 0, 36580210170460317737762146444885635769591964296289890711389087000847139534806165797517572963756420701630101713343229692997790887039708011239887899158602488099058023454307392387825436996066794401349180417178870019892425641929320878895403740655587101563655595067050855919740156100994268635382369423383067032821)]
```

#### Implement

Bài mày ta chỉ cần chú ý đến phần này là giải được

```python
Mat = matrix(Zmod(n), [
    [2, 1] + [get_random(nbit) for _ in range(4)],
    [0, 2] + [get_random(nbit) for _ in range(4)],
    [0, 0] + [4, 1] + [get_random(nbit) for _ in range(2)],
    [0, 0] + [0, 4] + [get_random(nbit) for _ in range(2)],
    [0, 0] + [0, 0] + [8, 1],
    [0, 0] + [0, 0] + [0, 8]
])

C = Mat^FLAG
C = list(C)
```

Python Implementations

```python
from Crypto.Util.number import *

C = [(34285747519707996626385667339662460790207453899564234933279840884637317470277963204844978855648863282661822817842406467276103235437115285776600339324582650206354227684286926765912841373720037206104315460984467834472878792871363724319500026730744559032592830317957861116684230815080884748210510265257121727411, 82389813574193236731268728055226346949935905889688170425892513962291738546070054175286986817742962125712704451033935523159914920684418980229184675189392660990212113237529057511102468180315624316711603102279872782413287481544411903032504611191117588506754985276936284421146109462510942343677179125102460355334, 127247078267314356402767966557448505733207679608121587776826570427528349536126399258128998506925096202352385266899982179247602157054605592001529350471426605916092686761690699179270970709575073044160148478140835495982904453410049961250136921488023338211130908836050232268149658252094451825981649386429967157023, 110997696050305177374684801376195205614043414698289134283464488914579055650336577562089998807469786126102628845652757901772021003891120075086100794690060492018372114798499796476503564426511552576093110306562634265833200794380828146503816203682087385703698944330589010185628240036153869595329794474678963954269, 95429943964904023259514531987953637596024020044100694025548029082876352647190904910373013883591092911247251504859346180249828148105405110896981416324094823746473360350150849817138654025822760100976625537661710179191573475427725481576122332324895773326199055069720422096583714906980119788052757109463536989130, 76925650644921944564121660415039326382672571942134701742579804900375156897677412516140878223663671839157682242947665571676520752706843330108967323669457404588586535061237444710279897627741144122937187393054928934936687732687921193790751566393662886825169077208127284176632544803227991370949818150005932210304), (0, 34285747519707996626385667339662460790207453899564234933279840884637317470277963204844978855648863282661822817842406467276103235437115285776600339324582650206354227684286926765912841373720037206104315460984467834472878792871363724319500026730744559032592830317957861116684230815080884748210510265257121727411, 85967636444726554256032386847538080607273641997139556709873191645024773479482183751659433639594934875197169824518560503372716992088412826701271790577397701838066670897181757432783438839115526851698428389903365201752735197054876789440370911041505435306549154757322168278884403206082946661059841799276902279607, 110321848943899292929831522195898953167052692821484311182642200713072229078674653831094653900345561159369211814825383018259327689455180388330932020089176571654576145870074563603252413779245365342554600824303390696086590372070050354595330074227342114164575397697848706436203854215556384244963529017935602600689, 55321436108075224950728586469455754360500596962017688262306497027259209074949803121055336152763619653715618911652213266949708309957674991371935559144633368828172207173145372615220450607178667764319048810554905786212377479905241378131059006116348325599909367174854478256625377537634718283487921887388679931300, 121048214328487578063535470984430739166205977393814304445813791572773220134359940700786671669567539273399625221907347167959074671295760177948556479010579225978917918535032412717072730223986401267581116138177971941402742413385270319230751393845616816965070450211819298226894334399356881715479006792296977303116), (0, 0, 80891788386112939497749276978496951092908047537517752191112348346041605282820278415204830919700840360371114407873821260986140627885494462923855784343766007471406691139724032186081486065167152331309928933439563087594932165713814698240940689654799590764311096627705559355661741126880749623083953480524440103996, 98127807327139994371479310755482264253499077621954160265776803909962087269443207623777017430975688540885576031084499718360878131623357206459366594111595569751254398053416214104147757969318816248746123610412479211529236153906708864168414330919431944363564172025204269508207805032491500543298879609362168155698, 65511482182385099252523608525317643713139065614405324455763784441479732896196144143630212812577305057210145612770975280343168022555945650814573970996890826522557999047275529322348420693034478105886809355222570889445527587635177667364042090723912339748512431185136779345494523747668733698804934976215893958288, 47395420931311533463576620820998773093140094423967370338777509171164699213419123512474441784558146041667540557107610725716163070022770572094504815720978368593469076026134774205916872923158523446883115622548066715665889163816586554653727221255672945695748970848307935789400330008330191289067490505817853508862), (0, 0, 0, 80891788386112939497749276978496951092908047537517752191112348346041605282820278415204830919700840360371114407873821260986140627885494462923855784343766007471406691139724032186081486065167152331309928933439563087594932165713814698240940689654799590764311096627705559355661741126880749623083953480524440103996, 19698820472058378412126192842030797220400882933373012220982539297272840493833295012123104281630408975161684583174403520414441877705582176563034772573895923595952612217426667572338807473485060098014543992573292667351072747962727283791740574278403611513201362656878372277715791010274896917611983518661952140153, 123510953871821884312855093053364645536177520009689630246292371010124299893864894909800725518340823661094473516585146142340021906280407678497822070318952778328284650261834023459467329786786889648844029738405121401290299843929018994002831246816483309594538299064894303565350991068375984784398159294612728278815), (0, 0, 0, 0, 36580210170460317737762146444885635769591964296289890711389087000847139534806165797517572963756420701630101713343229692997790887039708011239887899158602488099058023454307392387825436996066794401349180417178870019892425641929320878895403740655587101563655595067050855919740156100994268635382369423383067032821, 39071393947194921035771816301731926515001496696996162605545586710593160202215733075781810261530483080161843001707288615255381706789857593381598670763208249387924275996361728526530257131514765795139507343167639937751870811497537961210868263876827751668386006289349446841212411861730197725192485058916383785937), (0, 0, 0, 0, 0, 36580210170460317737762146444885635769591964296289890711389087000847139534806165797517572963756420701630101713343229692997790887039708011239887899158602488099058023454307392387825436996066794401349180417178870019892425641929320878895403740655587101563655595067050855919740156100994268635382369423383067032821)]

C00 = C[0][0]
C01 = C[0][1]
C55 = C[5][5]
C33 = C[3][3]

n = GCD(C00 ^ 3 - C55, C00^2 - C33)
n = n // 5
G = Zmod(n)
C00 = G(C00)
C01 = G(C01)

Flag = C01 * C00^(-1) * 2
print(long_to_bytes(int(Flag)))
```

### RSAn’t

#### Attachments

```python
from random import *
from sage.all import *
from Crypto.Util.number import *
from secret import flag

def encrypt():
    tmp = randint(2**1023, 2**1024)
    p = next_prime(1337*tmp + randint(2, 2**512))
    q = next_prime(7331*tmp + randint(2, 2**512))
    N = p*q
    return N

def l3ak(n):
    print('Security Alert!!')
    print('There is a L3AKER l3aking our data!! [~] :/\n')
    c1 = pow(bytes_to_long(b"factoring modulus?"), e, n)
    c2 = pow(bytes_to_long(b"without the modulus?"), e, n)
    return c1, c2

e = 65537
n = encrypt()
enc = pow(flag, e, n)
c1, c2 = l3ak(n)

print(f'Encrypted flag = {enc}\n')
print(f'c1 = {c1}\n')
print(f'c2 = {c2}\n')
```

```text
# output
e = 65537

ciphertext = 179299686848994539141122382962230037744384497621603198124077003991636319769603564062817092353600906591207476251327282277695110268704615120068654776183507204512702766847930125900500659983050185274344899025779726523565280032908194763356944549824963215339419038543390439655210741510143003582737996617770895692162306286064421718892797213765237300926925675153074894532935937291295802157305724856321584517131226940140190491157709894421683196766707672593154406263054436900566231464719102312973247466510418770039194000878897515838985623461176782628261365771619698859295767451162504151010728056594695117040661023327968023451519804564

c1 = 123377882241082251325350065419048806024607608617091688983830323277604694641240653374439302807138122463323990418348747537591347656262195555533468416119550902963546537686539626424151682647446653286178409257716563958279306978514921053134482777035689209563599648603507287706662378931300585730154813000147325737518201568052630101704051194396183990174893718130243703251255733422231215114594356086085529845721945162634747194330158630722370297888040809287372214916411109961066039419282486341414973486625115394106601990911459069075609672097833893961312251252396858703096951885954537748265354572684903035976149443662164781331591137509

c2 = 216996462348882812127549126696128848915007479735759067925583940914005783704777739383583486500248026532990006813147882357469539758674416271697210195684094572116588619081813131930186778045755089586040232978039441432232050042271853194470413044599117641325812011411950889172242559099135026172425733801215110286748370156962444409678069139574351948837982999861835569715249682828276876910129256029485173183675521926552841364713489224945222100475996799601024631599522598983661501357640196487134275394097207489818217501235732511301942649024362999538093008833593968191799917057618382726046836320499881842515455356124359654138411130319
```

#### Implements

Mình sẽ recover n như sau

```python
from sage.all import *
from Crypto.Util.number import *

e = 65537
c1 = 123377882241082251325350065419048806024607608617091688983830323277604694641240653374439302807138122463323990418348747537591347656262195555533468416119550902963546537686539626424151682647446653286178409257716563958279306978514921053134482777035689209563599648603507287706662378931300585730154813000147325737518201568052630101704051194396183990174893718130243703251255733422231215114594356086085529845721945162634747194330158630722370297888040809287372214916411109961066039419282486341414973486625115394106601990911459069075609672097833893961312251252396858703096951885954537748265354572684903035976149443662164781331591137509
c2 = 216996462348882812127549126696128848915007479735759067925583940914005783704777739383583486500248026532990006813147882357469539758674416271697210195684094572116588619081813131930186778045755089586040232978039441432232050042271853194470413044599117641325812011411950889172242559099135026172425733801215110286748370156962444409678069139574351948837982999861835569715249682828276876910129256029485173183675521926552841364713489224945222100475996799601024631599522598983661501357640196487134275394097207489818217501235732511301942649024362999538093008833593968191799917057618382726046836320499881842515455356124359654138411130319

m1 = bytes_to_long(b'factoring modulus?')
m2 = bytes_to_long(b'without the modulus?')

N = gcd(pow(m1, e) - int(c1), pow(m2, e) - int(c2))
print(f'{N = }')

# N = 573705313470237088128697724011345537729683894813773026784491075891375787623474876644061916906451471924722277144379030941570465205946833957200688304499122972757670018621482568140886956686009200092360197152239823056384412058625497863977546406937961142478700220534582896797390680947594209881481624425897931034297127910081669705880067174821720273642918776110649889916889528110735095592416817545242751005238512957101272680451113761426278203742295886722523975429342004312924930404678014280113729314434769051596435530057776346632601974236264442330943600999709043920136852080203441976582246277392355669576484507651557516413526616046
```

```python
def encrypt():
    tmp = randint(2**1023, 2**1024)
    p = next_prime(1337*tmp + randint(2, 2**512))
    q = next_prime(7331*tmp + randint(2, 2**512))
    N = p*q
    return N
```

Chúng ta có thể thấy rằng các bit cao của cả hai số nguyên tố (p và q) đều giống nhau, sự khác biệt có thể nằm ở các bit thấp 512. Điều này có nghĩa là nếu chúng ta tính căn bậc hai của N (isqrt(N)), thì các bit cao sẽ tương ứng với các bit cao của p và q

```python
tmp = isqrt((N)/(1337*7331))
q_approx = 7331*tmp - 2**512
```


Bây giờ chúng ta có thể tạo ra một đa thức 

$$\boxed{F(x) = x + q_{approx} \mod N}$$

Sử dụng phương pháp Coppersmith, chúng ta có thể tìm các nghiệm

Recover Flag.

Python Implementation

```python
from sage.all import *
from Crypto.Util.number import *
from factordb.factordb import FactorDB

e = 65537

ciphertext = 179299686848994539141122382962230037744384497621603198124077003991636319769603564062817092353600906591207476251327282277695110268704615120068654776183507204512702766847930125900500659983050185274344899025779726523565280032908194763356944549824963215339419038543390439655210741510143003582737996617770895692162306286064421718892797213765237300926925675153074894532935937291295802157305724856321584517131226940140190491157709894421683196766707672593154406263054436900566231464719102312973247466510418770039194000878897515838985623461176782628261365771619698859295767451162504151010728056594695117040661023327968023451519804564

c1 = 123377882241082251325350065419048806024607608617091688983830323277604694641240653374439302807138122463323990418348747537591347656262195555533468416119550902963546537686539626424151682647446653286178409257716563958279306978514921053134482777035689209563599648603507287706662378931300585730154813000147325737518201568052630101704051194396183990174893718130243703251255733422231215114594356086085529845721945162634747194330158630722370297888040809287372214916411109961066039419282486341414973486625115394106601990911459069075609672097833893961312251252396858703096951885954537748265354572684903035976149443662164781331591137509

c2 = 216996462348882812127549126696128848915007479735759067925583940914005783704777739383583486500248026532990006813147882357469539758674416271697210195684094572116588619081813131930186778045755089586040232978039441432232050042271853194470413044599117641325812011411950889172242559099135026172425733801215110286748370156962444409678069139574351948837982999861835569715249682828276876910129256029485173183675521926552841364713489224945222100475996799601024631599522598983661501357640196487134275394097207489818217501235732511301942649024362999538093008833593968191799917057618382726046836320499881842515455356124359654138411130319

m1 = bytes_to_long(b'factoring modulus?')
m2 = bytes_to_long(b'without the modulus?')

N = gcd(pow(m1, e) - int(c1), pow(m2, e) - int(c2))
print(f'{N = }')

f = FactorDB(N); f.connect(); [p, q] = f.get_factor_list()
print(f"{p = } \n {q = }")
N = N // 2


tmp = isqrt(N/(1337*7331))
print(f'{tmp = }')

q_approx = 7331*tmp - 2**512
F.<x> = PolynomialRing(Zmod(N), implementation='NTL')
f = x + q_approx
roots = f.small_roots(X=2**512, beta=0.1)

for delta in roots:
    q = q_approx + delta
    p = int(N) // int(q)
    phi = (p-1)*(q-1)
    d = pow(e, -1, phi)
    flag = long_to_bytes(int(pow(ciphertext, d, N))).decode()
    print(f'flag = {flag}')
```

### Related

#### Attachments

```python
import random
from flag import FLAG
from Crypto.Util.number import getPrime, bytes_to_long, long_to_bytes

p = getPrime(1024)
q = getPrime(1024)
n = p * q
e = 0x101

def pad(flag):
    m = bytes_to_long(flag)
    a = random.randint(2, n)
    b = random.randint(2, n)
    return (a, b), a*m+b

def encrypt(flag):
    padded_variables, padded_message = pad(flag)
    encrypted = pow(padded_message, e, n)
    return padded_variables, encrypted

variables, ct1 = encrypt(FLAG)
a1 = variables[0]
b1 = variables[1]

variables, ct2 = encrypt(FLAG)
a2 = variables[0]
b2 = variables[1]

print(f"{n = }")
print(f"{a1 = }")
print(f"{b1 = }")
print(f"{ct1 = }")
print(f"{a2 = }")
print(f"{b2 = }")
print(f"{ct2 = }")
```

```text
# output

n = 23446116820809956009508921267229329419806339208735431213584717790131416299556366048048977867380629435292555358502917305856047632651197352306945681062223443217527823509039445684919455982744684852068434951030105274549124012946448685060750456093120953320196777137936137902703756422225716380021864017594031233341531336018572970546112899850343992552126107820367629786159724290948728494321350895295087900001068499072242213916345639268473176748281877628559969801359815109260695490545357491404689132480248206287353580339535458835525161032145136894301169515951010316007454927062229765757932923091679510627796469997185047770119
a1 = 8104040836262507446864591234691358718164908580334110843106050982408624642389131164005601569999434432648709609777743793997208912520844943698036947408725027128235833538793471035056805185723079446135588491317378316082567779128276652380455054959975686544145446500257748715018799178783100289455255670805079936852471138049711583797615770901244436979110584710970079641409159097959783566594440737682826559724447739807028855072087914855150495360099989261682566388742966224528680792157619533719489447251411976029565538810357759752921276377948448704648350306514866111068184157760563297810978279434204440014428745729905509605285
b1 = 1728445028759460100268916851157941317747744991464848324630394207912877842639961858831903114707815701742483947978256582554473425946268457939887471248397622887505458768276338958573804608581353987536415380192782284575648580559755923454408763552113403890642303139141765381991794536720006159278517578791058556250982111713910060167032647218698362613084823406687399478088149985930840603408274198692032083156828441656375986195794109996772306557258447129571560905620272546405603257541870547380051900022925294193741417962861863860715434297040138205460211370506997331099668562619882982110566078451957682401843673938997454325985
ct1 = 7133574145118001624468851232768367610776481589816189114081484875167835285211475440236501712634938993477027789627285581268361018888589847771555770716521123959004389671272089766710340921550798461319697963644164596608774387203602804547184454077314801365322929817266934087883757605888082111393091270686060676504784482770435773757625762542094784777964406426404482882414828990658303263295993951921074284755818657012216398826105099627761519486438690405668440835527144374828045319113524249938249744799530870449189528166252037249009094063960558703857141043081099174412277124506544776530125652348821688752923438304710034397792
a2 = 6932198124642373427967232343817468902255209063707505631753623131468591968939116907766874533903771236309508029958603993113318003707536772796355326212684792901937391081839814883783063784050698582961314998290360613480778658142959804536224436521802834308095784814005774038096434723020316915995654759582638114351622288228138452404715021874261743824588698845194567350953613460211780903933501965152586633117799392776012574047439430079820078546000748259648002297803211427390366076552057374120223207399161502626197672749700677144769182115211864885324511059266535644202147069163420794861424973102200053615106664642762054707456
b2 = 17570492860498497589391311850810042101436988882059207563836745301643757694348737390349588510867234608796253222240056487274815481193573640552151307710984790365040907600873879523821340341063776797845384078798440533883164972773525749702026085462782235008812515983104980108840777316735468521572249232663287631112374534186975231033281807029801530398687397396929300293283833448151885674196708775598652356402354479252567714152805778278207736053329489014866155493921442482258381840272615320018058870234668488517354399053820878325928972260161611818894133121294554947400621261460441395783860055835185154356326202402937413717222
ct2 = 8778761624514690203726370366823530128900480928985439769115219364620387269991756967930541323829570453896164780238656562595733025340650482503284244625778872560261904887674968133049252085507078563540106328260114811619983171932648876602484063356832075687231100750407167402096299904835776594509894740386041222719008023556447633524625419665210188090816622517361786836014525679069179481575048514551967532281399777505866483289055530051032001545010914680661193107730444980281645735808124289602346876529763644878375393094200846185413267940739865639764057094273259729425291615810027734657664217752026488492540376475948687563210
```

#### Implement

Với bài này khá giống bài [Bespoke padding Cryptohack](https://vanluongkma.github.io/posts/RSA-Cryptohack/#26-bespoke-padding) sử dụng cách tấn công [Franklin–Reiter related-message](https://en.wikipedia.org/wiki/Coppersmith%27s_attack)

Python Implementation

```python
from Crypto.Util.number import *
from sage.all import *

e = 0x101
n = 23446116820809956009508921267229329419806339208735431213584717790131416299556366048048977867380629435292555358502917305856047632651197352306945681062223443217527823509039445684919455982744684852068434951030105274549124012946448685060750456093120953320196777137936137902703756422225716380021864017594031233341531336018572970546112899850343992552126107820367629786159724290948728494321350895295087900001068499072242213916345639268473176748281877628559969801359815109260695490545357491404689132480248206287353580339535458835525161032145136894301169515951010316007454927062229765757932923091679510627796469997185047770119
a1 = 8104040836262507446864591234691358718164908580334110843106050982408624642389131164005601569999434432648709609777743793997208912520844943698036947408725027128235833538793471035056805185723079446135588491317378316082567779128276652380455054959975686544145446500257748715018799178783100289455255670805079936852471138049711583797615770901244436979110584710970079641409159097959783566594440737682826559724447739807028855072087914855150495360099989261682566388742966224528680792157619533719489447251411976029565538810357759752921276377948448704648350306514866111068184157760563297810978279434204440014428745729905509605285
b1 = 1728445028759460100268916851157941317747744991464848324630394207912877842639961858831903114707815701742483947978256582554473425946268457939887471248397622887505458768276338958573804608581353987536415380192782284575648580559755923454408763552113403890642303139141765381991794536720006159278517578791058556250982111713910060167032647218698362613084823406687399478088149985930840603408274198692032083156828441656375986195794109996772306557258447129571560905620272546405603257541870547380051900022925294193741417962861863860715434297040138205460211370506997331099668562619882982110566078451957682401843673938997454325985
ct1 = 7133574145118001624468851232768367610776481589816189114081484875167835285211475440236501712634938993477027789627285581268361018888589847771555770716521123959004389671272089766710340921550798461319697963644164596608774387203602804547184454077314801365322929817266934087883757605888082111393091270686060676504784482770435773757625762542094784777964406426404482882414828990658303263295993951921074284755818657012216398826105099627761519486438690405668440835527144374828045319113524249938249744799530870449189528166252037249009094063960558703857141043081099174412277124506544776530125652348821688752923438304710034397792
a2 = 6932198124642373427967232343817468902255209063707505631753623131468591968939116907766874533903771236309508029958603993113318003707536772796355326212684792901937391081839814883783063784050698582961314998290360613480778658142959804536224436521802834308095784814005774038096434723020316915995654759582638114351622288228138452404715021874261743824588698845194567350953613460211780903933501965152586633117799392776012574047439430079820078546000748259648002297803211427390366076552057374120223207399161502626197672749700677144769182115211864885324511059266535644202147069163420794861424973102200053615106664642762054707456
b2 = 17570492860498497589391311850810042101436988882059207563836745301643757694348737390349588510867234608796253222240056487274815481193573640552151307710984790365040907600873879523821340341063776797845384078798440533883164972773525749702026085462782235008812515983104980108840777316735468521572249232663287631112374534186975231033281807029801530398687397396929300293283833448151885674196708775598652356402354479252567714152805778278207736053329489014866155493921442482258381840272615320018058870234668488517354399053820878325928972260161611818894133121294554947400621261460441395783860055835185154356326202402937413717222
ct2 = 8778761624514690203726370366823530128900480928985439769115219364620387269991756967930541323829570453896164780238656562595733025340650482503284244625778872560261904887674968133049252085507078563540106328260114811619983171932648876602484063356832075687231100750407167402096299904835776594509894740386041222719008023556447633524625419665210188090816622517361786836014525679069179481575048514551967532281399777505866483289055530051032001545010914680661193107730444980281645735808124289602346876529763644878375393094200846185413267940739865639764057094273259729425291615810027734657664217752026488492540376475948687563210

def gcd(a, b):
    while b:
        a, b = b, a % b
    return a.monic()

P.<X> = PolynomialRing(Zmod(n))
f1 = (a1*X + b1)^e - ct1
f2 = (a2*X + b2)^e - ct2
m = int(-gcd(f1, f2).coefficients()[0])
print(long_to_bytes(m).decode())
```

### Really Simple Algorithm

#### Attachments

```python
from Crypto.Util.number import getPrime, bytes_to_long as btl

menu = '''(1) Encrypt Message
(2) Receive Flag
(3) Exit'''

e = 1337
size = 1024
# flag = open('flag.txt', 'r').read().rstrip()
flag = "L3AK{H4sTAD5_bR0aDc45T_4TtacK_1s_pr3tTy_c0ol!}"


print('Welcome to the L3ak Really Simple Algorithm (RSA) Encryption Service™!')
print('Here you can encrypt your own message, or choose to receive the encrypted flag.')
print('Good luck!\n')

while True:

    p, q = getPrime(size), getPrime(size)
    n = p*q
    print(menu)

    option = int(input('Select Option: '))
    if option == 1:
        message = btl(input('Your Message: ').encode())
        enc_msg = pow(message, e, n)
        print(f'n = {n}')
        print(f'c = {enc_msg}')
    elif option == 2:
        enc_flag = pow(btl(flag.encode()), e, n)
        print(f'n = {n}')
        print(f'flag = {enc_flag}')
    elif option == 3:
        print('Goodbye!')
        exit()
    else:
        print('Invalid choice! Please try again.')
```

#### Implement

Với bài này ta sử dụng [Chinese remainder theorem](https://en.wikipedia.org/wiki/Chinese_remainder_theorem) với ``e = 1337``, [Hastad’s Broadcast Attack](https://vanluongkma.github.io/posts/RSA-&-Attack/#hastad-broadcast-attack)

```python
from pwn import *
import gmpy2
from tqdm import tqdm
from sage.all import *
from Crypto.Util.number import long_to_bytes as ltb

def getMenu(r):
    for _ in range(3):
        line = r.recvline().rstrip().decode()
    line = r.recvuntil(b': ').rstrip().decode()

r = process(["python3", "a.py"])
r.recvline()
r.recvline()
r.recvline()
r.recvline()

e = 1337
c_list = []
n_list = []
for i in tqdm(range(e)):
    print(i)
    getMenu(r)
    r.sendline(b'2')
    line = r.recvline().rstrip().decode()
    n = int(line.split(' ')[2])
    n_list.append(n)
    line = r.recvline().rstrip().decode()
    c = int(line.split(' ')[2])
    c_list.append(c)
r.close()

x = int(CRT_list(c_list, n_list))
m = int(gmpy2.iroot(x, int(e))[0])
flag = ltb(m).decode()
print(flag)
```

### Paillien tourist

#### Attachments

```python
from sage.all import *
from random import randint
from Crypto.Util.number import *

class Paillier:
    def __init__(self, bits):
        self.bits = bits
        self.pub, self.priv = self.keygen()

    def keygen(self):
        p = random_prime(2**self.bits)
        q = random_prime(2**self.bits)
        Lambda = (p - 1) * (q - 1)
        n = p * q
        Zn = IntegerModRing(n)
        Zn2 = IntegerModRing(n**2)
        g = Zn2(n + 1)
        mu = Zn(Lambda)**-1
        return ((n, g), (Lambda, mu))

    def encrypt(self, m):
        (n, g) = self.pub
        Zn2 = IntegerModRing(n**2)
        r = Zn2(randint(0, n))
        c = g**Zn2(m) * r**n
        return c

    def add(self, cipher_1, cipher_2):
        (n, g) = self.pub
        Zn2 = IntegerModRing(n**2)
        r = Zn2(randint(0, n))
        return cipher_1 * cipher_2 * r**n

    def sub(self, cipher_1, cipher_2):
        (n, g) = self.pub
        Zn2 = IntegerModRing(n**2)
        r = Zn2(randint(0, n))
        inv_cipher_2 = Zn2(cipher_2)**-1
        return cipher_1 * inv_cipher_2 * r**n

    def get_keys(self):
        return self.pub, self.priv

def toStr(msg):
    return long_to_bytes(int(msg))

# Generate key pairs
def main():
    paillier = Paillier(1024)
    pub_key, priv_key = paillier.get_keys()
    message_1 = randint(0, 420)
    cipher_1 = paillier.encrypt(message_1)
    message_2 = bytes_to_long(b"im so smrt, check me out mom")
    cipher_2 = paillier.encrypt(message_2)
    flag_message = bytes_to_long(b"L3AK{FAKE_FLAG_FAKE_FLAG}")
    flag_cipher = paillier.encrypt(flag_message)
    diff_cipher = paillier.sub(cipher_2, cipher_1)
    flag_cipher_modified = paillier.add(flag_cipher, diff_cipher)
    with open("challenge1.txt", "w") as f:
        f.write(f"Ciphertext #1 = {hex(int(cipher_1))}\n")
        f.write(f"Ciphertext #2 = {hex(int(cipher_2))}\n")
        f.write(f"Modified Flag Cipher = {hex(int(flag_cipher_modified))}\n")
        f.write(f"Public Key = {hex(int(pub_key[0]))}, {hex(int(pub_key[1]))}\n")
        f.write(f"Private Key = {hex(int(priv_key[0]))}, {hex(int(priv_key[1]))}\n")
    

if __name__ == '__main__':
    main()
```

```text
# output
Ciphertext #1 = 0x14060da59e64dc74087b911f612d2c45d8253cb3d7cb322b3aea545b05460880b7c5cd99cdaad15d2bf7b92a5315c9cf6e1c962ebb1100e1b9d0b5f768419069cb4e53281c15d8a432f90ad33c6a3680c7a56df8680bf22765b4b5977bc30cdb49ea1dab83694268bf6869dcd587a8be2475330c339d441e8ce254559c3fe5e2b0296dd0239924e318d86b4c9f2babd2b49bf103fb6cc340e0bffe0dac3fda06aeb1e763f9d6713d62aee4aa9b7806b9dd1f311a528cd9531d997dfe31190f457af2576a79e4f873da57a28da763e07037dd6c7d14ef978bdcb857c7559ebe774c8db2ca34fc5841df1362ae768db89690216594c48ef23bd131618c3978a3bb36d420907947d862490376e20a9af43583960641b37a5733ee4082f8eb750d30eb8177e8af1d2589785b81d7e74c9ad386ef8280bc6c0d275bb95bb0cffd8b3e73db2e438880ff2f7bdd2bdfc0c8f3ee5265196d11eb9e4f5db8d643d5dc2d7c5372bad82d62cd2966ce033c5c609db288ef8484a664f4e33d19ce218ced0e7f46256c41d827813f4cb65425240762cc6e1c87421ff851c50f0c011e39655640bf3b8db0f43cb5ed93fb1967209d446d996c29abd76fa952fe31050b85d0e350dddc924421c3606d686e72d5764e0a596c95607ecb92a7cc7fe8c8b031e2877774f7df1e842107a4048306449ca7d66eb0cbfcd13b6b6cd3e2ae719b8e20530
Ciphertext #2 = 0x50258985886970e93e6b0105d26e42efe033a8216f721eaf981f89e9287b04ddfe5f16d3f6fcef6e814376c266e6738b29e47eb70b97fa9ff03e0e29e17d32d131550b94df94b7484f73592ecd15848594e9fc93e3401848b437bd6a8c67159c5410a32eebeab7285365ea69bfeeaaef975af1dd55c250bc30c709cdc631aa678f7e2795c6c5d66187974de4c6bfb30da14a9f9a91fcac9eccb463196d621ecdbeda28d682401c960a2dca58730766a6cecb83630ca92523b5bdd7c97019adc1754d0598d082cf51337e434bd2683d70ca074c276dc0e386a3a9a9ef189eff84a2acbdd7c1891c113589244d41d541dbc7a88639ab05b3c57cdd8fdfdbc7d3a9619bb8b0db85ce3e66640d2e1821da55ebdfb09e73230a08ad49d72707d4639763c8196568eb5654466743dd66c6cf37fafc97004aa0c063f54b145fb8d33dea6eb371af6e66d3e6fb3fa082712b5e4ad70580808fd650cc056aa17a88cc4ad0387701237f81a7039071aac653314a7dfe6fccd2b1e87cdf43832425a97ff9c5383133b6e984d9fb2132a80ee9b05cc7a2a493f9bc2197ba940826cdedd667a515d1554539eabc1ebdc9dd2075b80f98fa5e125a78891e64eb57f5e5eba97200d5c76f5d49646eda8671f5d289c1f8ca7c5033466b636052f10fbf0026c3c15f19b805271f9322a1c674cc33f69b725feb8a9087c05cc490c63fb467f499d9f
Modified Flag Cipher = 0x410f09e83a921ff2e06f9af688d56962be6b6db5472d84c802c89505bc80dcb06f09fba8cea712f3bd0af654b1e9c7010a20fe4bee9537c3e44771b90547103f9a313df10de3df68862c98ce7bfff47dc0547b65867b0990fd9ac496bf8e5df6c4fc8ad2ad074fb5083532dbb1f2373b9183770e2fda35498fa1753bb8ec4b1fcf80f100ae20eb8e865ef80e46435f75ec998af6cebb64717d76af38f926470207b8753bd94c0e55d7eaf7a5c352d718feead815aa886e585865c812f840da04fa24f411fc5917efcfc7549a41a22aed031842309709d93eb4818c62a00614f0ac13ac909454cb56780658d6188f813ba77ae52b76b2979423d9e62118a17114b8572a3219fda1e9399d91249fbb32b4e06615ce91de513f14231f42fe6b1e27027a22841554399b5c699a68dd308f0d11ed00580d703e9ea61710378b06bf3e55a4c6405e523184a3f4f9838c06ee650c7002b69106c8d7569c7f0628093fe61acbd2ce52654f6ebed132789daba9b26b989e3c6283326dec6c63df9ecfb60620cac002e680691d3cb8e4b4139596973a333eb5942f8512919e6b338631675c2c9ab58115aeaee009870a2a3d121c16574476211cdac81b78618f101315c694005ab7478546538e43559c3d29fb9508a1ca5a6e7afc046d0b450165f34ed611156ab9485adffd118013f8477ed8b7cf95f9008d0f140226644c99920af5633
Public Key = 0x250fb952a1b9ed84701fa2fe7b90615e4144635d26a566231e2eeefae591c74fdf8a775425cf26ee84b48460417ff1859f4279c703258b325e7196656293c9225db58a9b6054fa83a2e44fc00eb058dd3e1660fbdc79cfd427aa90b0e0efdc40e02753c715ea9e7de1f282554d99c22ba883ca433577f8eac31dcfa55117c933cb69c969d91065a5276eb07e81caaf4fb332cc0f40cf5c049b8e8c78288f7b7a7d71fc5e1dba03eab6359bca909157e8a422c03ec852ae8b6fd8eaf7a37b2e3b680448f42724a3431aa73df3debdc052791ee2d0d57499fa2f1a21cb10bfdd14c148545d59fb7c90b679d44d4ad298ea6e15f4782faf9c53b8c3cda7536f11a5, 0x250fb952a1b9ed84701fa2fe7b90615e4144635d26a566231e2eeefae591c74fdf8a775425cf26ee84b48460417ff1859f4279c703258b325e7196656293c9225db58a9b6054fa83a2e44fc00eb058dd3e1660fbdc79cfd427aa90b0e0efdc40e02753c715ea9e7de1f282554d99c22ba883ca433577f8eac31dcfa55117c933cb69c969d91065a5276eb07e81caaf4fb332cc0f40cf5c049b8e8c78288f7b7a7d71fc5e1dba03eab6359bca909157e8a422c03ec852ae8b6fd8eaf7a37b2e3b680448f42724a3431aa73df3debdc052791ee2d0d57499fa2f1a21cb10bfdd14c148545d59fb7c90b679d44d4ad298ea6e15f4782faf9c53b8c3cda7536f11a6
Private Key = 0x250fb952a1b9ed84701fa2fe7b90615e4144635d26a566231e2eeefae591c74fdf8a775425cf26ee84b48460417ff1859f4279c703258b325e7196656293c9225db58a9b6054fa83a2e44fc00eb058dd3e1660fbdc79cfd427aa90b0e0efdc40e02753c715ea9e7de1f282554d99c22ba883ca433577f8eac31dcfa55117c933057d339c308438050366c6b40808a18b4448dfe495c06abe52abdaaeb86381c86a14ad5d91ff1b25aaf1e82d0e429c8622cd435389169a066357ef488c1725ec0812d3a8edd7bc93d5ac7344c074169dbfd52949913cb9779ce1f7aab96b9a8a554fb17493075a862ab37d30ea4fe91e5ee6f9b95e280b297e91357454800c60, 0x21c0ff97d130be489dd28344be8a9022b1ecbca51a8555c52e3512f65786623289f7effbda90d9e52e3066af88464b5157984983fdbd4a0a60eea984bb427230d6f4e0de54954ccc8efc58127b58fb02fed0ea47f4bd28072be2e02fa58abf65d15a644a55f847feca9e29596aa9fb6137d0bfa68c1a69e1f425f20063c8bf256b7aa3920b149169ca4cabbe2c3668d8edbca2d0f7e7d0d131397a0b102339f6824153f7b6bc7837f255dd947ef53607e0ef91f08665e9125fc374689c3d515985d28313e1b9d4c2554e8780bb485f3e7c5999a30b94d2b5d0762b5adf7a031782a0488249ca109e9590aa9e611ed2dbc4ea9758d397d30ce11b0f8c2a683bc6
```

#### Implement

Bài này ta chỉ cần đọc doc [Paillier cryptosystem](https://en.wikipedia.org/wiki/Paillier_cryptosystem) là làm được

Python Implementation

```python
from Crypto.Util.number import *
from sage.all import *

n = int("0x250fb952a1b9ed84701fa2fe7b90615e4144635d26a566231e2eeefae591c74fdf8a775425cf26ee84b48460417ff1859f4279c703258b325e7196656293c9225db58a9b6054fa83a2e44fc00eb058dd3e1660fbdc79cfd427aa90b0e0efdc40e02753c715ea9e7de1f282554d99c22ba883ca433577f8eac31dcfa55117c933cb69c969d91065a5276eb07e81caaf4fb332cc0f40cf5c049b8e8c78288f7b7a7d71fc5e1dba03eab6359bca909157e8a422c03ec852ae8b6fd8eaf7a37b2e3b680448f42724a3431aa73df3debdc052791ee2d0d57499fa2f1a21cb10bfdd14c148545d59fb7c90b679d44d4ad298ea6e15f4782faf9c53b8c3cda7536f11a5", 16)
g = int("0x250fb952a1b9ed84701fa2fe7b90615e4144635d26a566231e2eeefae591c74fdf8a775425cf26ee84b48460417ff1859f4279c703258b325e7196656293c9225db58a9b6054fa83a2e44fc00eb058dd3e1660fbdc79cfd427aa90b0e0efdc40e02753c715ea9e7de1f282554d99c22ba883ca433577f8eac31dcfa55117c933cb69c969d91065a5276eb07e81caaf4fb332cc0f40cf5c049b8e8c78288f7b7a7d71fc5e1dba03eab6359bca909157e8a422c03ec852ae8b6fd8eaf7a37b2e3b680448f42724a3431aa73df3debdc052791ee2d0d57499fa2f1a21cb10bfdd14c148545d59fb7c90b679d44d4ad298ea6e15f4782faf9c53b8c3cda7536f11a6", 16)
Lambda = int("0x250fb952a1b9ed84701fa2fe7b90615e4144635d26a566231e2eeefae591c74fdf8a775425cf26ee84b48460417ff1859f4279c703258b325e7196656293c9225db58a9b6054fa83a2e44fc00eb058dd3e1660fbdc79cfd427aa90b0e0efdc40e02753c715ea9e7de1f282554d99c22ba883ca433577f8eac31dcfa55117c933057d339c308438050366c6b40808a18b4448dfe495c06abe52abdaaeb86381c86a14ad5d91ff1b25aaf1e82d0e429c8622cd435389169a066357ef488c1725ec0812d3a8edd7bc93d5ac7344c074169dbfd52949913cb9779ce1f7aab96b9a8a554fb17493075a862ab37d30ea4fe91e5ee6f9b95e280b297e91357454800c60", 16)
mu = int("0x21c0ff97d130be489dd28344be8a9022b1ecbca51a8555c52e3512f65786623289f7effbda90d9e52e3066af88464b5157984983fdbd4a0a60eea984bb427230d6f4e0de54954ccc8efc58127b58fb02fed0ea47f4bd28072be2e02fa58abf65d15a644a55f847feca9e29596aa9fb6137d0bfa68c1a69e1f425f20063c8bf256b7aa3920b149169ca4cabbe2c3668d8edbca2d0f7e7d0d131397a0b102339f6824153f7b6bc7837f255dd947ef53607e0ef91f08665e9125fc374689c3d515985d28313e1b9d4c2554e8780bb485f3e7c5999a30b94d2b5d0762b5adf7a031782a0488249ca109e9590aa9e611ed2dbc4ea9758d397d30ce11b0f8c2a683bc6", 16)
cipher1 = int("0x14060da59e64dc74087b911f612d2c45d8253cb3d7cb322b3aea545b05460880b7c5cd99cdaad15d2bf7b92a5315c9cf6e1c962ebb1100e1b9d0b5f768419069cb4e53281c15d8a432f90ad33c6a3680c7a56df8680bf22765b4b5977bc30cdb49ea1dab83694268bf6869dcd587a8be2475330c339d441e8ce254559c3fe5e2b0296dd0239924e318d86b4c9f2babd2b49bf103fb6cc340e0bffe0dac3fda06aeb1e763f9d6713d62aee4aa9b7806b9dd1f311a528cd9531d997dfe31190f457af2576a79e4f873da57a28da763e07037dd6c7d14ef978bdcb857c7559ebe774c8db2ca34fc5841df1362ae768db89690216594c48ef23bd131618c3978a3bb36d420907947d862490376e20a9af43583960641b37a5733ee4082f8eb750d30eb8177e8af1d2589785b81d7e74c9ad386ef8280bc6c0d275bb95bb0cffd8b3e73db2e438880ff2f7bdd2bdfc0c8f3ee5265196d11eb9e4f5db8d643d5dc2d7c5372bad82d62cd2966ce033c5c609db288ef8484a664f4e33d19ce218ced0e7f46256c41d827813f4cb65425240762cc6e1c87421ff851c50f0c011e39655640bf3b8db0f43cb5ed93fb1967209d446d996c29abd76fa952fe31050b85d0e350dddc924421c3606d686e72d5764e0a596c95607ecb92a7cc7fe8c8b031e2877774f7df1e842107a4048306449ca7d66eb0cbfcd13b6b6cd3e2ae719b8e20530", 16)
cipher2 = int("0x50258985886970e93e6b0105d26e42efe033a8216f721eaf981f89e9287b04ddfe5f16d3f6fcef6e814376c266e6738b29e47eb70b97fa9ff03e0e29e17d32d131550b94df94b7484f73592ecd15848594e9fc93e3401848b437bd6a8c67159c5410a32eebeab7285365ea69bfeeaaef975af1dd55c250bc30c709cdc631aa678f7e2795c6c5d66187974de4c6bfb30da14a9f9a91fcac9eccb463196d621ecdbeda28d682401c960a2dca58730766a6cecb83630ca92523b5bdd7c97019adc1754d0598d082cf51337e434bd2683d70ca074c276dc0e386a3a9a9ef189eff84a2acbdd7c1891c113589244d41d541dbc7a88639ab05b3c57cdd8fdfdbc7d3a9619bb8b0db85ce3e66640d2e1821da55ebdfb09e73230a08ad49d72707d4639763c8196568eb5654466743dd66c6cf37fafc97004aa0c063f54b145fb8d33dea6eb371af6e66d3e6fb3fa082712b5e4ad70580808fd650cc056aa17a88cc4ad0387701237f81a7039071aac653314a7dfe6fccd2b1e87cdf43832425a97ff9c5383133b6e984d9fb2132a80ee9b05cc7a2a493f9bc2197ba940826cdedd667a515d1554539eabc1ebdc9dd2075b80f98fa5e125a78891e64eb57f5e5eba97200d5c76f5d49646eda8671f5d289c1f8ca7c5033466b636052f10fbf0026c3c15f19b805271f9322a1c674cc33f69b725feb8a9087c05cc490c63fb467f499d9f", 16)
cipher_flag_modified = int("0x410f09e83a921ff2e06f9af688d56962be6b6db5472d84c802c89505bc80dcb06f09fba8cea712f3bd0af654b1e9c7010a20fe4bee9537c3e44771b90547103f9a313df10de3df68862c98ce7bfff47dc0547b65867b0990fd9ac496bf8e5df6c4fc8ad2ad074fb5083532dbb1f2373b9183770e2fda35498fa1753bb8ec4b1fcf80f100ae20eb8e865ef80e46435f75ec998af6cebb64717d76af38f926470207b8753bd94c0e55d7eaf7a5c352d718feead815aa886e585865c812f840da04fa24f411fc5917efcfc7549a41a22aed031842309709d93eb4818c62a00614f0ac13ac909454cb56780658d6188f813ba77ae52b76b2979423d9e62118a17114b8572a3219fda1e9399d91249fbb32b4e06615ce91de513f14231f42fe6b1e27027a22841554399b5c699a68dd308f0d11ed00580d703e9ea61710378b06bf3e55a4c6405e523184a3f4f9838c06ee650c7002b69106c8d7569c7f0628093fe61acbd2ce52654f6ebed132789daba9b26b989e3c6283326dec6c63df9ecfb60620cac002e680691d3cb8e4b4139596973a333eb5942f8512919e6b338631675c2c9ab58115aeaee009870a2a3d121c16574476211cdac81b78618f101315c694005ab7478546538e43559c3d29fb9508a1ca5a6e7afc046d0b450165f34ed611156ab9485adffd118013f8477ed8b7cf95f9008d0f140226644c99920af5633", 16)
Zn = IntegerModRing(n)
Zn2 = IntegerModRing(n**2)

_C = cipher2 * pow(cipher1, -1, n**2) % n**2
C_flag = cipher_flag_modified * pow(_C, -1, n**2) % n**2
L = lambda x: (x - 1) // n
flag = L(pow(C_flag, Lambda, n**2)) * mu % n
print(long_to_bytes(flag))
```
### Crypto on the rocks

#### Attachments

```python
from sage.all import *
from typing import Tuple
import hashlib
from Crypto.Cipher import AES
from Crypto.Util.number import long_to_bytes
from Crypto.Util.Padding import pad
from Crypto.Random import get_random_bytes
import re
p = 0x01ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
K = GF(p)
a = K(0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc)
b = K(0x0051953eb9618e1c9a1f929a21a0b68540eea2da725b99b315f3b8b489918ef109e156193951ec7e937b1652c0bd3bb1bf073573df883d2c34f1ef451fd46b503f00)
E = EllipticCurve(K, (a, b))
G = E(0x00c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66, 0x011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650)
E.set_order(0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409 * 0x1)
n = G.order()

# FLAG: str = open('flag.txt', 'r').read().strip()
FLAG: str = "L3AK{9_b1ts_12_m0r3_th4n_3n0ugh}"
KEY: int = randint(1, n - 1)
Q: int = KEY*G
AES_KEY = hashlib.sha256(long_to_bytes(KEY)).digest()

INVALID_ATTEMPTS = 0

def banner() -> str:
    banner = """\n
██████████╗░░█████╗░░█████╗░███████╗█
[=] ------------ Menu------------ [=]
[+] !1: Get Public Key            [+]
[+] !2: Sign a message            [+]
[+] !3: Verify a signature        [+]
[+] !4: Get the encrypted flag    [+]
[+] !5: Exit                      [+]
[=] ------------------------------[=]
██████████╗░░█████╗░░█████╗░███████╗█
\r\n"""
    return banner
def get_k() -> int:
    return int.from_bytes(hashlib.sha512(os.urandom(512//8)).digest(), byteorder='big') % n

def digest(msg) -> int:
    if isinstance(msg, str):
        msg = msg.encode()
    return int.from_bytes(hashlib.sha256(msg).digest(), byteorder='big')


def ecdsa_verify(Q, m, r, s) -> bool:
    e = digest(m)
    w = pow(s, -1, n)
    u1 = int((e * w) % n)  
    u2 = int((r * w) % n)  
    P = (u1 * G) + (u2 * Q)
    return r == int(P.xy()[0])


def ecdsa_sign(d: int, m: str) -> Tuple[int, int]:
    e = digest(m)
    k = get_k()
    P = k * G
    r_i = int(P.xy()[0])
    s_i = (pow(k, -1, n) * (e+r_i*d)) % n
    return (r_i, s_i)

def send_flag() -> str:
        flag = FLAG.encode()
        iv = get_random_bytes(16)
        cipher = AES.new(AES_KEY, AES.MODE_CBC, iv)
        ct = cipher.encrypt(pad(flag, AES.block_size))
        return (iv + ct).hex()

def handle_signing() -> tuple:
    while True:
        try:
            inp = input("Enter message to sign. (`!exit`) to return to the main menu.\n\n>> ")
            if inp == "!exit":
                break
            r,s = ecdsa_sign(KEY, inp)
            print(f"Signature (r,s): {(r, s)}")
            
        except Exception as e:
            print(f"Error during signing: {e}")
            continue

def is_valid_format(inp) -> bool:
    pattern = r"^\([^,]+,\d+,\d+\)$"
    match = re.match(pattern, inp)
    return bool(match)

def handle_verfication():
    while True:
        inp = input("Enter the message you want to verify in the format `message,r,s` (`!exit` to return to the main menu).\n\n>> ")
        if inp == '!exit':
            break
        valid = is_valid_format(inp)
        if not valid:
            print("Invalid input format. Please try again.\n")
            continue
        message, r, s = inp.split(',')
        print(f"message: {message}\nr: {r}\ns: {s}\n")
        try:
            i_r, i_s = int(r), int(s)
            valid = ecdsa_verify(Q, message, i_r, i_s)
            result = "Signature is valid\n" if valid else "Signature is invalid\n"
            print(result)
        except Exception as e:
            print(f"Error during verification: {e}")
            continue
        


def process_option(option: str) -> str:
    global INVALID_ATTEMPTS
    if option == '!1':
        INVALID_ATTEMPTS = 0
        public_key_info = f"Public Key (X, Y): {Q.xy()}\n"
        print(public_key_info)
    elif option == '!2':
        INVALID_ATTEMPTS = 0
        handle_signing()
    elif option == '!3':
        INVALID_ATTEMPTS = 0
        handle_verfication()
    elif option == '!4':
        INVALID_ATTEMPTS = 0
        enc_flag = send_flag()
        print(f"Encrypted Flag: {enc_flag}\n")
    elif option == '!5':
        print("Goodbye!\n")
        return False
    else:
        INVALID_ATTEMPTS += 1
        print("Invalid option... Try again\n")
        if INVALID_ATTEMPTS >= 3:
            print("Too many invalid attempts. Exiting.\n")
            return False
    return True
        



def main():
    try:
        b = banner()
        print(b+"\n")
        while True:
            
            inp = input(">> ")
            if not process_option(inp):
                sys.exit(0)
    except Exception as e:
        print(f"An error occurred: {e}, please try again later.\n")
        pass
    
    finally:
        sys.exit(0)

if __name__ == '__main__':
    main()
```

#### Implement

Phương pháp : lấy 100 phương trình, sử dụng Bias

```python
from sage.all import *
from typing import Tuple
from  hashlib import sha256
from Crypto.Cipher import AES
from Crypto.Util.number import *
from Crypto.Util.Padding import pad
from Crypto.Random import get_random_bytes
import re
from pwn import *
from tqdm import *
p = 0x01ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
K = GF(p)
a = K(0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc)
b = K(0x0051953eb9618e1c9a1f929a21a0b68540eea2da725b99b315f3b8b489918ef109e156193951ec7e937b1652c0bd3bb1bf073573df883d2c34f1ef451fd46b503f00)
E = EllipticCurve(K, (a, b))
G = E(0x00c6858e06b70404e9cd9e3ecb662395b4429c648139053fb521f828af606b4d3dbaa14b5e77efe75928fe1dc127a2ffa8de3348b3c1856a429bf97e7e31c2e5bd66, 0x011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650)
E.set_order(0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409 * 0x1)
n = G.order()
q = n
arr = []
B = 2 ** (q.nbits()-8)
def digest(msg) -> int:
    if isinstance(msg, str):
        msg = msg.encode()
    return int.from_bytes(sha256(msg).digest(), byteorder='big')
io = process(["python3", "main.py"])
io.recvuntil(b">> ")
io.sendline(b'!2')
for i in tqdm(range(100)):
    io.recvuntil(b">> ")
    msg = str(i)
    io.sendline(msg.encode())
    io.recvuntil(b"Signature (r,s): ")
    res = io.recvline().decode().strip().replace("(","").replace(")","").split(", ")
    r = int(res[0])
    s = int(res[1])
    arr.append({
        'msg': msg,
        'r': str(r),
        's': str(s)
    })
io.sendline(b"!exit")
io.recvuntil(b">> ")
io.sendline(b'!4')
io.recvuntil(b"Encrypted Flag: ")
res = bytes.fromhex(io.recvline().decode().strip())
iv = res[:16]
ct = res[16:]
print(iv,ct)


Mtilde = [B, 0]
Rtilde = [0, B / q]

for sig in arr:
    m, r, s = sig['msg'].encode(), int(sig['r']), int(sig['s'])

    m = digest(m)
    print(m)
    Mtilde += [m * inverse(s, q) % q]
    Rtilde += [r * inverse(s, q) % q]

Mtilde = matrix(QQ, 1, len(Mtilde), Mtilde)
Rtilde = matrix(QQ, 1, len(Rtilde), Rtilde)

Pdiag = -q * identity_matrix(QQ, len(arr));

Z = matrix(QQ, len(arr), 2, [0 for i in range(len(arr)*2)] )

# We construct the final matrix assembling all blocks
M = block_matrix([[Z, Pdiag]])
M = block_matrix([[Mtilde], [Rtilde], [M]])

L = M.LLL()

found = 0
for row in L.rows():
    if found:
        break
    for i in range(len(arr)):
        if found:
            break
        
        m, r, s = sig['msg'].encode(), int(sig['r']), int(sig['s'])

        m = digest(m)
        solk = row[i + 2]
        if solk == 0: 
            continue
        for k in [solk, -solk]:
            d = inverse(r, q) * (int(k) * s - m) % q
            AES_KEY = sha256(long_to_bytes(int(d))).digest()
            cipher = AES.new(AES_KEY, AES.MODE_CBC, iv)
            flag = cipher.decrypt(ct)
            if b'L3AK{' in flag:
                print(flag)
```

### QuantumL3ak

Directory : [QuantumL3ak](https://github.com/vanluongkma/CTF-Writeups/tree/819d6c390e27b3c07f80283eaace000be26ed65a/L3ak%20CTF%202024/Quantum_L3ak)

#### Attachments

```python
import os
import random
import json

from collections import namedtuple
from typing import Dict
from qiskit import QuantumCircuit
from qiskit_aer import StatevectorSimulator
from qiskit_aer.backends.compatibility import Statevector
from random import Random
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad

from enum import Enum

API_CHOICE = Enum("API_CHOICE", ["UploadCircuit", "DisplayCircuit", "PerformMeasurement", "Exit"])
API = namedtuple("API", ["ShortDesc", "Action"])
API_MAX_REQUEST = 3200
API_MENU : Dict[str, API] = {}

def build_api_menu(rng, statesim : StatevectorSimulator):
    global API_MENU
    API_MENU = {
        API_CHOICE.UploadCircuit: API(
            ShortDesc="Upload a circuit",
            Action=upload_circuit
        ),
        API_CHOICE.DisplayCircuit: API(
            ShortDesc="Display the uploaded circuit",
            Action=display_circuit
        ),
        API_CHOICE.PerformMeasurement: API(
            ShortDesc="Perform a measurement",
            Action=lambda: perform_measurement(rng, statesim)
        ),
        API_CHOICE.Exit: API(
            ShortDesc="Exit",
            Action=None
        )
    }

noise_circuit : QuantumCircuit = None
uploaded_circuit : QuantumCircuit = None
outcomes = []

def generate_noise():
    circuit = QuantumCircuit(8)
    controls = random.sample(range(8), k = 4)
    dependents = set(range(8)) - set(controls)
    for c in controls:
        circuit.h(c)
        coupled = random.sample(list(dependents), k=1)
        dependents -= set(coupled)
        for cx in coupled:
            circuit.cx(c, cx)
    return circuit

def setup(rng):
    global noise_circuit
    noise_circuit = generate_noise()
    build_api_menu(rng, StatevectorSimulator())

def display_menu(api_requests):
    print("You may:")
    for i, (_, api) in enumerate(API_MENU.items(), 1):
        print(f"{i}. {api.ShortDesc}")
    print(f"You have made {api_requests}/{API_MAX_REQUEST} requests")

def print_encrypted_flag(rng : Random):
    key = rng.getrandbits(128).to_bytes(16, byteorder='little')
    iv  = rng.getrandbits(128).to_bytes(16, byteorder='little')
    aes = AES.new(key, mode=AES.MODE_CBC, iv=iv)
    with open("./flag.txt", "rb") as flagfile:
        flag = pad(flagfile.read(), 16)
    ciphertext : bytes = aes.encrypt(flag)
    print("Flag:")
    print("ct:", ciphertext.hex())
    print("iv:", iv.hex())

def display_circuit():
    if uploaded_circuit is not None:
        print(uploaded_circuit.draw())
    else:
        print("No circuit has been uploaded")

def upload_circuit():
    global uploaded_circuit
    try:
        result = json.loads(input("Enter circuit json:"))
    except Exception:
        print("invalid json")
        return

    circuit = QuantumCircuit(8)
    try:
        for gate in result["gates"]:
            parse = gate.split(" ")
            if parse[0] == "H":
                which = int(parse[1])
                circuit.h(which)
            elif parse[0] == "CX":
                controller, controlled = int(parse[1]), int(parse[2])
                circuit.cx(controller, controlled)
    except Exception as e:
        print("Input is invalid.")
        print("Expected input is of the form:")
        print('{"gates": ["H 0", "CX 0 1", "H 3"]}')
        return
    print("Circuit has been uploaded")
    print(circuit.draw())
    uploaded_circuit = circuit

def perform_measurement(rng : Random, statesim : StatevectorSimulator):
    circuit = QuantumCircuit(8)
    noise = noise_circuit.copy()
    circuit = circuit.compose(noise)
    if uploaded_circuit is not None:
        circuit = circuit.compose(uploaded_circuit)
    result = statesim.run(circuit).result()
    statevector : Statevector = result.get_statevector()
    probs_dict = statevector.probabilities_dict()
    states = []
    probs = []
    state_count = len(probs_dict)
    for state in sorted(probs_dict.keys()):
        states.append(state)
        probs.append(round(probs_dict[state]*state_count))
    print(rng.choices(states, weights=probs)[0])

def main():
    api_requests = 0
    rng = Random(os.urandom(8))

    setup(rng)
    while True:
        if api_requests == API_MAX_REQUEST:
            break
        display_menu(api_requests)
        try:
            user = input("Choice: ")
            choice = API_CHOICE(int(user))
        except Exception as e:
            print("Invalid Choice", e)
        if choice not in API_MENU:
            print("Invalid Choice")
        elif choice == API_CHOICE.Exit:
            break
        else:
            API_MENU[choice].Action()
            api_requests += 1
        print("")
    print_encrypted_flag(rng)

if __name__ == "__main__":
    main()
```

#### Implement

:((

### 